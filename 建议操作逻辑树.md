# DRIA AI 对话建议操作逻辑树

## 🌳 完整逻辑流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    用户进入对话页面                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  💡 检查大模型配置                                           │
│  - 已配置：正常使用                                          │
│  - 未配置：显示提示 + [如何配置API] [继续使用模拟模式]      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  🤖 欢迎消息                                                 │
│  "您好！我是DRIA AI报表生成助手..."                         │
│                                                              │
│  建议操作:                                                   │
│  • [上传CSV文件]     ────┐                                  │
│  • [上传Excel文件]   ────┤                                  │
│  • [查看示例数据]    ────┘                                  │
└─────────────────────────────────────────────────────────────┘
           │                │                │
           ↓                ↓                ↓
    [上传文件]      [查看示例数据]      [正常对话]
           │                │                │
           ↓                ↓                └──→ 继续对话...
┌──────────────────┐  ┌──────────────────┐
│  📄 文件上传成功  │  │  📋 示例数据说明  │
│  检测到N个通道   │  │                  │
└──────────────────┘  └──────────────────┘
           │                │
           └────────┬───────┘
                    ↓
┌─────────────────────────────────────────────────────────────┐
│  📊 报表类型选择                                             │
│                                                              │
│  建议操作:                                                   │
│  • [生成稳态分析报表]        ──→  配置稳态参数              │
│  • [生成功能计算报表]        ──→  配置功能参数              │
│  • [生成状态评估报表]        ──→  配置评估参数              │
│  • [生成完整分析报表]        ──→  按顺序配置三大报表        │
│  • [生成其他报表类型(.json)] ──→  上传JSON配置文件          │
└─────────────────────────────────────────────────────────────┘
           │         │         │         │         │
           ↓         ↓         ↓         ↓         ↓
```

---

## 📋 详细分支流程

### 1️⃣ 稳态分析报表流程

```
[生成稳态分析报表]
       │
       ↓
┌──────────────────────────────────────┐
│  配置稳态分析参数                     │
│  "请指定用于判断稳定状态的主要通道"   │
│                                       │
│  建议操作:                            │
│  • [使用 Ng(rpm)]                     │
│  • [使用 Temperature(°C)]             │
│  • [使用 Pressure(kPa)]               │
│  • [自定义通道]                       │
└──────────────────────────────────────┘
       │
       ↓
┌──────────────────────────────────────┐
│  参数确认                             │
│  显示配置的通道、条件、时间窗口       │
│                                       │
│  建议操作:                            │
│  • [确认生成]                         │
│  • [修改配置]                         │
│  • [取消]                             │
└──────────────────────────────────────┘
       │
       ↓ [确认生成]
   生成报表 ──→ 显示下载按钮
```

### 2️⃣ 功能计算报表流程

```
[生成功能计算报表]
       │
       ↓
┌──────────────────────────────────────┐
│  配置功能计算参数                     │
│  "功能计算包括以下指标..."            │
│                                       │
│  建议操作:                            │
│  • [全部指标]                         │
│  • [仅时间基准]                       │
│  • [时间基准+启动时间]                │
│  • [自定义选择]                       │
└──────────────────────────────────────┘
       │
       ↓
┌──────────────────────────────────────┐
│  参数确认                             │
│                                       │
│  建议操作:                            │
│  • [确认生成]                         │
│  • [修改配置]                         │
│  • [取消]                             │
└──────────────────────────────────────┘
       │
       ↓ [确认生成]
   生成报表 ──→ 显示下载按钮
```

### 3️⃣ 状态评估报表流程

```
[生成状态评估报表]
       │
       ↓
┌──────────────────────────────────────┐
│  配置状态评估参数                     │
│  "状态评估包括以下检测项..."          │
│                                       │
│  建议操作:                            │
│  • [全部项目]                         │
│  • [仅超温检测]                       │
│  • [超温+Ng余转]                      │
│  • [自定义选择]                       │
└──────────────────────────────────────┘
       │
       ↓
┌──────────────────────────────────────┐
│  参数确认                             │
│                                       │
│  建议操作:                            │
│  • [确认生成]                         │
│  • [修改配置]                         │
│  • [取消]                             │
└──────────────────────────────────────┘
       │
       ↓ [确认生成]
   生成报表 ──→ 显示下载按钮
```

### 4️⃣ **完整分析报表流程（按顺序引导）**

```
[生成完整分析报表]
       │
       ↓
┌──────────────────────────────────────┐
│  第一步：配置稳态分析                 │
│  "让我们从稳态分析开始..."            │
│                                       │
│  建议操作:                            │
│  • [使用 Ng(rpm)]                     │
│  • [使用 Temperature(°C)]             │
│  • [使用 Pressure(kPa)]               │
│  • [自定义通道]                       │
└──────────────────────────────────────┘
       │
       ↓ [选择通道]
┌──────────────────────────────────────┐
│  第二步：配置功能计算                 │
│  "稳态分析配置完成！接下来..."        │
│                                       │
│  建议操作:                            │
│  • [全部指标]                         │
│  • [仅时间基准]                       │
│  • [时间基准+启动时间]                │
│  • [自定义选择]                       │
└──────────────────────────────────────┘
       │
       ↓ [选择指标]
┌──────────────────────────────────────┐
│  第三步：配置状态评估                 │
│  "功能计算配置完成！最后..."          │
│                                       │
│  建议操作:                            │
│  • [全部项目]                         │
│  • [仅超温检测]                       │
│  • [超温+Ng余转]                      │
│  • [自定义选择]                       │
└──────────────────────────────────────┘
       │
       ↓ [选择项目]
┌──────────────────────────────────────┐
│  配置完成摘要                         │
│  ✓ 稳态分析                           │
│  ✓ 功能计算                           │
│  ✓ 状态评估                           │
│                                       │
│  建议操作:                            │
│  • [确认生成完整报表]                 │
│  • [查看配置摘要]                     │
│  • [修改配置]                         │
└──────────────────────────────────────┘
       │
       ↓ [确认生成]
   生成报表 ──→ 显示下载按钮
```

### 5️⃣ 自定义 JSON 配置流程

```
[生成其他报表类型(.json)]
       │
       ↓
┌──────────────────────────────────────┐
│  JSON配置说明                         │
│  "您选择了使用自定义JSON配置..."      │
│                                       │
│  建议操作:                            │
│  • [上传JSON配置文件]  ←── 触发文件选择  │
│  • [查看JSON格式示例]                 │
│  • [返回选择其他报表]                 │
└──────────────────────────────────────┘
       │
       ↓ [上传JSON]
┌──────────────────────────────────────┐
│  文件选择对话框                       │
│  只接受 .json 文件                    │
└──────────────────────────────────────┘
       │
       ↓ 上传成功
   解析配置 ──→ 生成报表 ──→ 显示下载按钮
```

---

## 🎯 特殊功能分支

### 🔧 大模型配置检查

```
系统启动时 / 用户输入包含"配置"、"设置"、"API"
       │
       ↓
检查 localStorage 中的 API 配置
       │
       ├─ 已配置 ──→ 正常使用
       │
       └─ 未配置 ──→ 显示提示消息
                    │
                    ↓
              ┌─────────────────────────┐
              │  💡 配置提示            │
              │  "当前使用模拟对话模式"  │
              │                         │
              │  建议操作:              │
              │  • [如何配置API]        │
              │  • [继续使用模拟模式]   │
              │  • [了解更多]           │
              └─────────────────────────┘
                    │
                    ↓ [如何配置API]
              ┌─────────────────────────┐
              │  📝 配置步骤说明        │
              │  1. 打开控制台 (F12)    │
              │  2. 执行配置命令        │
              │  3. 刷新页面            │
              │                         │
              │  建议操作:              │
              │  • [继续使用模拟模式]   │
              │  • [我已配置完成]       │
              └─────────────────────────┘
```

### 📥 报表下载流程

```
报表生成完成
       │
       ↓
┌──────────────────────────────────────┐
│  ✅ 报表生成成功（新增气泡消息）      │
│  "您可以点击下方按钮下载报表文件"    │
│                                       │
│  建议操作:                            │
│  • [下载报表]       ←── 触发下载      │
│  • [查看报表列表]                     │
│  • [生成新报表]                       │
└──────────────────────────────────────┘
       │
       ↓ [下载报表]
   获取reportId ──→ 调用下载API ──→ 浏览器下载
                                     │
                                     ↓
                              Toast提示："报表下载成功"
```

---

## 🔍 按钮点击效果映射表

| 建议操作按钮              | 触发效果                               | 下一步建议                                 |
| ------------------------- | -------------------------------------- | ------------------------------------------ |
| **初始阶段**              |                                        |                                            |
| `上传CSV文件`             | 打开文件选择器（.csv）                 | → 文件上传成功后显示报表类型选择           |
| `上传Excel文件`           | 打开文件选择器（.xlsx/.xls）           | → 文件上传成功后显示报表类型选择           |
| `查看示例数据`            | 发送消息并显示示例说明                 | → `上传CSV文件` `上传Excel文件` `了解更多` |
| **报表类型选择**          |                                        |                                            |
| `生成稳态分析报表`        | 进入稳态分析配置流程                   | → 通道选择建议                             |
| `生成功能计算报表`        | 进入功能计算配置流程                   | → 指标选择建议                             |
| `生成状态评估报表`        | 进入状态评估配置流程                   | → 项目选择建议                             |
| `生成完整分析报表`        | 进入三步配置流程（稳态 → 功能 → 状态） | → 稳态通道选择                             |
| `生成其他报表类型(.json)` | 提示上传 JSON 配置文件                 | → `上传JSON配置文件` `查看JSON格式示例`    |
| **配置阶段**              |                                        |                                            |
| `使用 Ng(rpm)`            | 设置稳态分析通道为 Ng(rpm)             | → `确认生成` `修改配置`                    |
| `全部指标`                | 选择所有功能计算指标                   | → `确认生成` `修改配置`                    |
| `全部项目`                | 选择所有状态评估项目                   | → `确认生成` `修改配置`                    |
| `确认生成`                | 开始生成报表                           | → `下载报表` `查看报表列表`                |
| **JSON 配置**             |                                        |                                            |
| `上传JSON配置文件`        | 打开文件选择器（.json）                | → JSON 解析后生成报表                      |
| `查看JSON格式示例`        | 显示 JSON 配置格式文档                 | → `上传JSON配置文件`                       |
| **下载阶段**              |                                        |                                            |
| `下载报表`                | 触发浏览器下载 Excel 文件              | → Toast 提示"报表下载成功"                 |
| `查看报表列表`            | 跳转到报表管理页面                     | → 报表管理页面                             |
| `生成新报表`              | 重新开始对话流程                       | → 回到报表类型选择                         |
| **配置相关**              |                                        |                                            |
| `如何配置API`             | 显示 API 配置步骤说明                  | → `继续使用模拟模式` `我已配置完成`        |
| `继续使用模拟模式`        | 关闭配置提示，继续使用                 | → Toast 提示"当前使用模拟对话模式"         |
| `使用模拟模式`            | 同上                                   | → 同上                                     |

---

## 💡 设计亮点

### 1. **渐进式引导**

- 从简单到复杂：查看 → 了解 → 配置 → 生成
- 每一步都提供清晰的下一步建议

### 2. **循环收敛设计**

- 无论用户点击什么，最终都会引导回核心功能
- 核心入口：上传文件 → 选择报表类型 → 配置参数 → 生成下载

### 3. **完整分析报表的顺序引导**

- ✅ **第一步**：稳态分析配置
- ✅ **第二步**：功能计算配置
- ✅ **第三步**：状态评估配置
- ✅ **最后**：配置摘要确认

### 4. **容错与提示**

- 未配置大模型时自动提示
- 提供模拟模式作为备选方案
- 每个操作都有明确的反馈

### 5. **灵活的配置方式**

- 支持界面引导配置（三大报表）
- 支持 JSON 文件配置（自定义报表）
- 两种方式互补，满足不同用户需求

### 6. **下载体验优化**

- ✅ 生成完成后自动显示下载气泡消息
- ✅ 提供下载按钮建议操作
- ✅ 下载成功后 Toast 提示
- 完整的下载反馈链

---

## 🎨 实现细节

### 状态管理

```typescript
// ChatPage.tsx 中的状态跟踪
const [configContext, setConfigContext] = useState({
  stableStateConfigured: false, // 稳态分析是否配置
  functionalConfigured: false, // 功能计算是否配置
  statusEvalConfigured: false, // 状态评估是否配置
  stableChannel: "", // 选择的稳态通道
  reportType: "", // 报表类型
});
```

### 建议操作生成逻辑

```typescript
// aiService.ts 中根据上下文动态生成建议
-检查是否有文件上传 -
  检查当前配置状态 -
  根据报表类型生成对应建议 -
  根据配置完成度显示下一步操作;
```

### 特殊按钮处理

```typescript
// ChatPage.tsx 中的 handleActionClick
- 上传文件：触发文件选择器
- 上传JSON：触发JSON文件选择器（只接受.json）
- 下载报表：从消息中获取reportId并下载
- 配置相关：显示配置说明或继续使用
```

---

## 📊 完整对话示例

```
AI: 您好！我是DRIA AI报表生成助手...
    [上传CSV文件] [上传Excel文件] [查看示例数据]

💡 提示：当前使用模拟对话模式。如需启用真实AI对话功能，请配置大模型API。
    [如何配置API] [继续使用模拟模式]

用户: 点击 [上传CSV文件]
    → 文件选择器弹出

系统: 文件 "test_data.csv" 上传成功！检测到 8 个数据通道。

AI: 文件上传成功！我已经检测到您的数据文件包含 8 个数据通道。
    请选择您需要生成的报表类型：
    [生成稳态分析报表] [生成功能计算报表] [生成状态评估报表]
    [生成完整分析报表] [生成其他报表类型(.json)]

用户: 点击 [生成完整分析报表]

AI: 很好！我将帮您生成包含所有三个部分的完整分析报表。
    让我们从稳态分析开始。请选择用于判断稳定状态的主要通道：
    [使用 Ng(rpm)] [使用 Temperature(°C)] [使用 Pressure(kPa)] [自定义通道]

用户: 点击 [使用 Ng(rpm)]

AI: 稳态分析配置完成！
    接下来配置功能计算部分。请选择需要计算的指标：
    [全部指标] [仅时间基准] [时间基准+启动时间] [自定义选择]

用户: 点击 [全部指标]

AI: 功能计算配置完成！
    最后配置状态评估部分。请选择需要评估的项目：
    [全部项目] [仅超温检测] [超温+Ng余转] [自定义选择]

用户: 点击 [全部项目]

AI: 完整分析报表的所有配置已完成！

    包括：
    ✓ 稳态分析
    ✓ 功能计算
    ✓ 状态评估

    现在开始生成报表吗？
    [确认生成完整报表] [查看配置摘要] [修改配置]

用户: 点击 [确认生成完整报表]

AI: 正在生成报表，请稍候...
    报表生成完成后，您可以下载Excel文件查看详细结果。
    [查看报表列表] [生成其他类型报表]

系统: Toast: "报表生成完成！"

AI: ✅ 报表生成成功！您可以点击下方按钮下载报表文件。
    [下载报表] [查看报表列表] [生成新报表]

用户: 点击 [下载报表]
    → 浏览器开始下载 report_xxx.xlsx

系统: Toast: "报表下载成功"
```

---

## ✅ 已实现功能清单

- ✅ 完善 AI 服务的建议操作逻辑树
- ✅ 实现完整分析报表的按顺序参数填写
- ✅ 添加 JSON 文件上传功能（只接受.json）
- ✅ 修复报表下载后没有气泡提示的问题
- ✅ 添加大模型配置检查功能
- ✅ 未配置时自动提示并提供配置说明
- ✅ 支持模拟模式和真实 API 模式切换

---

**创建日期**: 2025-10-17  
**版本**: 1.0  
**系统**: DRIA AI 报表生成系统
