## 对话逻辑说明

概述：

- 系统包含两种模式：普通对话与配置模式。
- **上传文件后自动进入配置模式**；点击"完成配置"或"取消配置"后退出返回对话模式。
- 配置模式期间，"完成配置"和"取消配置"按钮始终显示在页面上方。

### 前端：模式判断

```typescript
// 位置：frontend/src/pages/ChatPage.tsx 第 239-359 行

handleSendMessage 函数判断：
├─ 如果 configMode.isActive === true
│  └─ 配置模式
│     ├─ 调用：/api/config-dialogue/update-config
│     └─ 使用配置对话API
│
└─ 如果 configMode.isActive === false
   └─ 普通对话模式
      ├─ 调用：/api/dialogue
      └─ 使用普通对话API
```

触发配置模式：

```typescript
// 位置：第 442-540 行
handleFileUploaded 函数：
└─ 用户上传文件后
   ├─ 自动分析文件通道信息
   ├─ POST /api/config-dialogue/start-config (自动调用)
   └─ 设置 configMode.isActive = true (自动进入配置模式)
   └─ 显示配置状态栏（"完成配置"和"取消配置"按钮始终可见）
```

退出配置模式：

```typescript
// 位置：第 92-150 行（handleCompleteConfig）
用户点击"完成配置"按钮
└─ 调用 /api/config-dialogue/complete-config
   └─ 生成报表
   └─ setConfigMode({ isActive: false }) // 退出配置模式

// 位置：第 193-237 行（handleCancelConfig）
用户点击"取消配置"按钮
└─ 调用 /api/config-dialogue/cancel-config
   └─ setConfigMode({ isActive: false }) // 退出配置模式
```

### 后端：路由分配

```python
# 位置：backend/api/routes/dialogue.py 第 118-153 行

@router.post("/ai_report/dialogue")
async def process_dialogue(request: DialogueRequest):
    # 检查是否有活跃的配置会话
    config_session = check_active_config_session(request.session_id)

    if config_session:
        # 配置模式：处理配置对话
        return await handle_config_dialogue_with_llm(request, config_session)
    else:
        # 普通对话模式：纯对话
        return await handle_normal_dialogue(request)
```

检查配置会话（第 156-167 行）：

```python
def check_active_config_session(session_id: str):
    session = config_manager.sessions.get(session_id)

    # 严格的检查条件：
    if session and
       session['state'] not in [INITIAL, COMPLETED] and  # 不是初始或已完成状态
       'report_type' in session and  # 有报表类型
       'params' in session:  # 有参数
        return session

    return None  # 普通对话
```

### 具体流程

场景 1：初始状态（普通对话）

```
用户进入系统
    ↓
显示欢迎消息
    ↓
configMode.isActive = false (普通对话模式)
    ↓
用户可以与AI进行普通对话
```

场景 2：上传文件后自动进入配置模式

```
用户：上传数据文件 "data.csv"
    ↓
前端：调用 handleFileUploaded()
    ├─ 分析文件通道信息
    ├─ 自动调用 POST /api/config-dialogue/start-config
    └─ 设置 configMode.isActive = true
    ↓
显示配置状态栏（"完成配置"和"取消配置"按钮）
    ↓
进入配置模式（用户通过自然语言配置参数）
```

场景 3：配置模式下的对话

```
用户：输入 "使用转速通道"
    ↓
前端：configMode.isActive = true
    ↓
调用：POST /api/config-dialogue/update-config
    ↓
后端：解析用户意图并更新配置
    ↓
返回：配置更新结果（参数已更新）
    ↓
配置状态栏显示更新后的参数
```

场景 4：完成配置退出

```
用户：点击"完成配置"按钮
    ↓
前端：调用 handleCompleteConfig()
    ↓
调用：POST /api/config-dialogue/complete-config
    ↓
生成报表
    ↓
setConfigMode({ isActive: false })
    ↓
退出配置模式，返回普通对话模式
    ↓
配置状态栏隐藏
```

场景 5：取消配置退出

```
用户：点击"取消配置"按钮
    ↓
前端：调用 handleCancelConfig()
    ↓
调用：POST /api/config-dialogue/cancel-config
    ↓
setConfigMode({ isActive: false })
    ↓
退出配置模式，返回普通对话模式
    ↓
显示：配置已取消，回到对话模式
    ↓
配置状态栏隐藏
```

### 关键要点

1. **自动进入配置模式**：
   - 用户上传文件后，系统自动进入配置模式。
   - 无需手动点击按钮，上传即进入配置流程。
2. **配置模式特征**：
   - 配置状态栏在页面上方始终显示。
   - "完成配置"和"取消配置"按钮在配置模式期间一直可见。
   - 用户可通过自然语言修改配置参数。
3. **退出配置模式**：
   - 只有点击"完成配置"或"取消配置"按钮才能退出配置模式。
   - 完成配置：生成报表后退出。
   - 取消配置：直接退出，返回普通对话模式。
4. 后端自动识别：
   - 检查配置会话是否存在且有效。
5. 配置对话处理：
   - 先规则解析；失败则用大模型辅助，并通过关键词过滤避免误判。
