# 稳定状态功能实现总结

## 完成时间

2024 年

## 功能概述

实现了根据触发条件抓取满足条件的时刻快照，并生成 Excel 报表的稳定状态计算功能。

## 实现的核心模块

### 1. 数据读取服务 (`backend/services/data_reader.py`)

- **功能**：读取 CSV/Excel 文件并转换为时序数据流
- **特性**：
  - 自动识别时间列（支持多种命名方式）
  - 支持多种编码格式
  - 返回标准化数据流格式
- **关键方法**：
  - `read_data_stream()`: 读取数据流，返回`(timestamp, {channel: value})`元组列表

### 2. 稳定状态计算引擎 (`backend/services/steady_state_calculator.py`)

- **功能**：根据触发条件计算并记录快照
- **特性**：
  - 双条件触发机制（统计型 + 变化率型）
  - 滑动时间窗口管理
  - 智能记录逻辑（上升沿触发、值变化触发）
  - 支持 AND、Cond1_Only、Cond2_Only 组合逻辑
- **关键类**：
  - `TriggerConfig`: 触发配置数据类
  - `StableStateConfig`: 稳定状态配置数据类
  - `SteadyStateCalculator`: 计算引擎

### 3. 报表生成器 (`backend/services/report_writer.py`)

- **功能**：将快照数据写入 Excel 并生成图表
- **特性**：
  - 自动创建 Excel 工作簿和工作表
  - 写入表头和数据
  - 生成折线图图表
- **关键类**：
  - `ReportWriter`: 报表生成器

### 4. 统一服务接口 (`backend/services/steady_state_service.py`)

- **功能**：协调各个模块，提供统一的服务接口
- **特性**：
  - 配置文件解析
  - 中英文翻译支持
  - 完整的调用流程管理
- **关键方法**：
  - `generate_report()`: 生成报表的主方法

### 5. API 端点 (`backend/api/routes/steady_state.py`)

- **功能**：提供 REST API 接口
- **端点**：
  - `POST /api/reports/steady_state/generate`: 生成报表
  - `GET /api/reports/steady_state/{report_id}/download`: 下载报表
- **请求模型**：
  - `SteadyStateRequest`: 请求参数
  - `SteadyStateResponse`: 响应数据

## 技术实现

### 算法核心

1. **滑动窗口**：使用`deque`双端队列实现高效的时间窗口管理
2. **统计计算**：支持 Average、Max、Min、RMS 四种统计方法
3. **触发逻辑**：实现上升沿检测和值变化检测
4. **组合逻辑**：支持多种条件组合方式

### 数据流

```
CSV文件 → DataReader → 数据流
         ↓
配置文件 → SteadyStateService → SteadyStateCalculator → 快照列表
         ↓
ReportWriter → Excel文件
```

### 配置格式

```json
{
  "reportConfig": {
    "stableState": {
      "displayChannels": ["通道列表"],
      "conditionLogic": "AND/Cond1_Only/Cond2_Only",
      "conditions": [
        {
          "type": "statistic",
          "channel": "通道名",
          "statistic": "统计方法",
          "duration": 窗口长度,
          "logic": "比较逻辑",
          "threshold": 阈值
        },
        {
          "type": "amplitude_change",
          "channel": "通道名",
          "duration": 窗口长度,
          "logic": "比较逻辑",
          "threshold": 阈值
        }
      ]
    }
  }
}
```

## 特性亮点

1. **灵活的触发机制**

   - 条件 1：统计型触发（上升沿）
   - 条件 2：变化率型触发（值变化或 10 分钟间隔）

2. **高效的数据处理**

   - 滑动窗口算法
   - 增量计算
   - 内存优化

3. **完整的报表输出**

   - Excel 格式
   - 自动图表生成
   - 清晰的表头和数据

4. **良好的扩展性**
   - 模块化设计
   - 易于添加新的统计方法
   - 支持自定义触发逻辑

## 测试

提供了完整的测试脚本 `backend/tests/test_steady_state.py`，包含：

- 数据读取器测试
- 计算引擎测试
- 完整服务流程测试

## 文档

- **使用文档**：`backend/docs/steady_state_usage.md`
- **API 文档**：Swagger UI (`http://127.0.0.1:8000/api/docs`)
  nete

## 依赖

所有依赖已在`backend/requirements.txt`中定义，主要依赖：

- pandas: 数据处理
- numpy: 数值计算
- openpyxl: Excel 文件操作
- fastapi: Web 框架

## 集成状态

- ✅ 已注册到主应用 (`backend/api/main.py`)
- ✅ 已添加到路由模块 (`backend/api/routes/__init__.py`)
- ✅ 无 linter 错误
- ✅ 完整的类型注解

## 使用示例

```python
from backend.services.steady_state_service import SteadyStateService

service = SteadyStateService()
report_path = service.generate_report(
    "config.json",
    "data.csv",
    "output_dir"
)
```

## 后续优化建议

1. 添加更多统计方法（如中位数、分位数等）
2. 支持更复杂的条件组合（OR、XOR 等）
3. 优化大文件处理性能
4. 添加进度追踪和回调功能
5. 支持自定义图表样式和模板
