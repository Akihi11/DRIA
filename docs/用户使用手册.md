## DRIA AI 报表生成与对话助手

### 1. 文档目的与适用人群

本手册用于指导业务人员、试验工程师及系统运维人员，正确使用 **DRIA AI 报表生成与对话助手**，完成试验数据的上传、配置与报表生成工作。

本系统通过对话式交互方式，结合结构化配置与专业计算引擎，为试验数据自动生成以下类型的 Excel 报表：

- **稳定状态参数汇总表**
- **功能计算汇总表**
- **状态评估表**
- **完整报表（包含上述三类报表）**

本文档不涉及底层算法实现与代码细节，如需了解技术实现请参考 `docs/开发文档.md` 及相关技术文档。

---

### 2. 系统总体说明

#### 2.1 系统功能概述

系统提供如下主要功能：

- **数据文件管理**支持上传 CSV、Excel（`.xlsx`、`.xls`）格式的试验数据文件，并进行基础统计分析。
- **对话式配置引导**通过自然语言对话及引导按钮，完成报表相关的参数选择、阈值设置、通道选择等配置过程。
- **多类型报表生成**按照配置生成稳定状态、功能计算、状态评估及完整报表，并提供本地下载。
- **配置留痕与会话管理**
  报表配置过程及最终配置文件可持久化存储，便于后续复用与审计。

#### 2.2 技术架构概览（简要）

- 前端：React + Vite，提供 Web 对话及配置界面。
- 后端：FastAPI，负责文件上传、数据分析、对话配置管理及报表生成。
- 报表存储：
  - **标准部署形态**：生成的报表内容以二进制形式存入数据库（`generated_reports` 等表），通过报表 ID 进行下载与管理；
  - 同时可在本地生成对应的 Excel 文件（`.xlsx`）用于调试或备份，默认目录为 `backend/reports/`。
- LLM 服务：通过环境变量配置 DeepSeek / OpenAI / 其他兼容模型，用于对话理解与配置生成。

---

### 3. 环境与访问方式

#### 3.1 运行环境要求

- 操作系统：Windows 10 / 11（本手册以 Windows 为示例）
- Python：3.12 及以上版本
- Node.js：18 及以上版本
- 浏览器：Chrome / Edge / 其他现代浏览器

#### 3.2 服务启动（已完成初次部署的前提下）

1. **启动后端服务**

   在项目根目录 `DRIA` 下：

   ```cmd
   cd backend
   start.bat
   ```

   或者手动方式：

   ```cmd
   cd backend
   venv\Scripts\activate
   python main.py
   ```

   正常情况下，控制台会显示类似：

   ```text
   Uvicorn running on http://127.0.0.1:8000
   Application startup complete.
   ```

2. **启动前端服务**

   ```cmd
   cd frontend
   npm run dev
   ```

3. **访问入口地址**

   - 前端应用（用户使用界面）：`http://localhost:5173`
   - 后端 API 文档（技术参考）：`http://127.0.0.1:8000/api/docs`
   - 后端健康检查：`http://127.0.0.1:8000/api/health`

> 若为第一次部署或需修改环境变量，请参考根目录下《环境配置指南.md》《部署说明.md》。

---

### 4. 用户界面说明

进入 `http://localhost:5173` 后，主页面整体由三部分构成：

1. **顶部配置状态栏（Config Status Bar）**

   - 显示当前是否处于报表配置流程中。
   - 显示当前报表类型（如“稳态分析”“功能计算”“状态评估”“完整报表”）。
   - 显示当前配置阶段（如“等待选择”“通道选择”“参数配置”“确认配置”“已完成”等）。
   - 在适当阶段展示关键配置参数的标签（如阈值、统计方法等）。
   - 右侧包含两个操作按钮：
     - **“完成配置 / 确认生成报表”**：结束当前配置并生成报表。
     - **“取消配置”**：中止当前配置流程并返回普通对话模式。

2. **中部对话区（Chat）**

   - 展示用户与 AI 的对话内容。
   - 展示系统自动生成的文件分析结果卡片（如通道统计）。
   - AI 回复中常附带 **建议操作按钮**，便于直接触发相应的配置步骤（例如“稳态参数”“功能计算”“下一步”“上一步”等）。

3. **底部输入与操作区**

   - 文本输入框：输入自然语言问题或配置指令；按回车发送（Shift+回车换行）。
   - 语音输入按钮（如浏览器支持 Web Speech）：可开始/停止语音识别，将语音转为文本。
   - **“上传”按钮**：选择并上传试验数据文件（CSV / Excel）。
   - **“发送”按钮**：发送当前输入内容。

---

### 5. 标准使用流程

本节介绍从“上传数据文件”到“下载报表”的完整使用流程，适用于大多数业务场景。

#### 5.1 步骤一：上传试验数据文件

1. 在页面底部点击 **“上传”** 按钮。
2. 在弹出的文件选择窗口中，选择本地的 CSV 或 Excel 文件（扩展名为 `.csv`、`.xlsx`、`.xls`）。
3. 上传成功后，界面会出现一条文件分析结果卡片，内容包括：
   - 文件名称与大小；
   - 检测到的通道数量；
   - 各通道的样本数、最小值、最大值、平均值、标准差等基本统计信息。
4. 同时，AI 会输出一条提示消息，通常会引导用户 **选择要生成的报表类型**，并在消息下方提供四个按钮：
   - “稳态参数”
   - “功能计算”
   - “状态评估”
   - “完整报表”

> 注意：在未选择任何报表类型之前，系统处于“等待选择报表类型”的初始配置状态。

#### 5.2 步骤二：选择报表类型

在 AI 消息下方，点击需要生成的报表类型：

- **稳态参数**：用于生成稳定状态参数汇总表（以下文中以“稳态分析”称呼）。
- **功能计算**：用于生成功能计算汇总表（启动时间、点火时间、Ng/Np 余转时间等）。
- **状态评估**：用于生成状态评估表（超温、余转时间是否合格等指标的判定）。
- **完整报表**：一次生成上述三类报表的综合报表。

选择后：

- 顶部配置状态栏会显示当前报表类型及配置阶段；
- 系统创建或更新报表配置会话；
- 后续对话与操作均围绕本次报表配置进行，直至“完成配置”或“取消配置”。

---

### 6. 各报表类型的操作说明

#### 6.1 稳态分析（稳态参数报表）

稳态分析用于从试验数据中识别稳定运行阶段，并汇总各通道在稳态区间内的参数情况。

##### 6.1.1 通道选择

1. 选择“稳态参数”后，系统会弹出 **“请选择用于稳态参数的通道”** 弹窗。
2. 弹窗中列出了上传文件中解析出的所有通道名称。
3. 用户可按需勾选一个或多个通道，常见选择包括但不限于：
   - 转速类：`Ng`、`Np`
   - 温度类：`Temperature(°C)` 等
   - 压力类：`Pressure(kPa)` 等
4. 弹窗底部提供“全选 / 取消全选”按钮，方便快速操作。
5. 选择完成后点击 **“确定”**，系统自动将选中通道提交给后端，并进入后续条件与阈值配置阶段。

##### 6.1.2 条件与阈值配置

1. 通道选择完成后，AI 会在对话区说明当前的默认稳态判定条件，例如：
   - 使用何种统计方法（如平均值）；
   - 使用多大时间窗口；
   - 使用何种阈值和逻辑判断（大于 / 小于等）。
2. 用户可通过两种方式调整配置：
   - **点击建议操作按钮**（如“修改阈值”“下一步”等）；
   - **以自然语言描述需求**，例如：
     - “将 Ng 的稳态阈值改为 15000 rpm，时间窗口 1 秒。”
     - “温度通道使用最大值作为判断依据。”
3. 系统会根据用户输入更新内部配置，并在对话中进行确认。

##### 6.1.3 确认与生成报表

1. 当配置完成后，顶部配置状态栏的状态通常会切换为“确认配置”或类似提示。
2. 用户可在任意合适时机点击状态栏右侧的 **“完成配置 / 确认生成报表”** 按钮。
3. 系统将使用当前配置生成稳态参数报表，生成成功后：
   - AI 在对话中提示报表生成成功；
   - 返回报表标识（ID）及下载链接或提示；
   - 报表文件会保存到后端 `backend/reports/` 目录。

#### 6.2 功能计算汇总表

功能计算汇总表用于统计各次“启动-停机”循环中的关键时间指标，例如“启动时间”“点火时间”“Ng / Np 余转时间”等。

##### 6.2.1 启动配置流程

1. 在建议操作中选择 **“功能计算”**。
2. 系统进入功能计算配置模式，顶部配置状态栏会显示“功能计算 / 配置中”。
3. 与稳态分析不同，此处不弹出通道多选弹窗，而是通过对话方式逐步引导用户确认：
   - 启动时间、时间基准点采用的通道及阈值；
   - 点火事件的判定规则（如 10 秒差分大于某阈值）；
   - Ng/Np 余转时间的上下阈值等。

##### 6.2.2 配置说明（概念层面）

为便于理解，以下为典型指标的含义（简要，详细算法请参阅《功能计算汇总表：开发规范文档》）：

- **启动时间**：从“转速首次超过低阈值”到“转速首次超过高阈值”的时间间隔。
- **点火时间**：监测某一通道（如滑油压力）在一段时间内的差分，当差分首次大于设定阈值时记为点火时刻，其相对于时间基准的差值即为点火时间。
- **Ng / Np 余转时间**：在降速阶段，从转速首次低于高阈值到首次低于低阈值的时间差，用来衡量转动惯性。

在配置阶段，用户只需要从业务角度描述需求，例如：

- “按默认规则计算所有指标。”
- “忽略 Np 余转时间，只保留 Ng 余转时间。”
- “点火使用滑油压力，10 秒差分大于 500 视为点火。”

系统会将这些要求转化为内部 JSON 配置并在对话中反馈概要信息。

##### 6.2.3 报表生成

功能计算配置完成后，用户点击顶部状态栏的 **“完成配置 / 确认生成报表”** 按钮，系统将：

- 识别数据中的一个或多个完整“启动-停机”循环；
- 对每个循环计算各指标；
- 将结果写入 Excel 汇总表，典型字段包括：
  - 启动次数
  - 时间（基准时刻）
  - 启动时间
  - 点火时间
  - Ng 余转时间
  - Np 余转时间

报表生成成功后，AI 会在对话中返回报表标识及下载提示。

#### 6.3 状态评估表

状态评估表用于对多项运行参数进行定性/定量判定，如超温、余转时间是否合格等。

##### 6.3.1 选择评估项目

1. 在建议操作中选择 **“状态评估”**。
2. 系统显示“请选择需要评估的项目”弹窗，其中列出可用评估项，例如：
   - 超温
   - 振动超限
   - Ng 余转时间
   - Np 余转时间
     等。
3. 对于仅生成“状态评估”报表的情形，某些功能类项目可能被设为不可选（用于保持配置一致性）；若生成“完整报表”，则功能类项目可联动使用。
4. 用户根据实际需要勾选一个或多个评估项目，亦可使用“全选 / 取消全选”完成快速操作。

##### 6.3.2 评估参数配置

1. 选择完成后，系统会将选择结果提交至后端并进入参数配置阶段。
2. 在对话中，AI 会引导用户为各评估项设置阈值、比较逻辑等，例如：
   - “超温阈值设为 850℃，大于该值视为异常”；
   - “Ng 余转时间大于 50 秒视为异常”等。
3. 用户可以根据业务规范，逐项确认和调整。

##### 6.3.3 报表生成

配置完成后，点击顶部状态栏的 **“完成配置 / 确认生成报表”** 即可生成状态评估表。生成的评估表通常包含：

- 评估项目名称；
- 使用的判定条件（通道、阈值、比较逻辑等）；
- 对应的计算结果与评估结论。

#### 6.4 完整报表

完整报表是对稳态分析、功能计算、状态评估三类报表的综合生成模式。

1. 在建议操作中选择 **“完整报表”**。
2. 系统首先弹出稳态通道多选弹窗，要求选择用于稳态及部分功能计算的基础通道。
3. 通道选择完成后，系统会依次引导完成：
   - 稳态分析配置；
   - 功能计算配置；
   - 状态评估配置。
4. 所有配置确认无误后，点击顶部状态栏的 **“完成配置 / 确认生成报表”**，系统将生成包含上述多个工作表的 Excel 报表，并在对话中给出下载提示。

---

### 7. 报表下载与文件位置

#### 7.1 通过前端界面下载

- 每当报表生成成功后，AI 回复中会返回报表相关信息，并通常提供下载按钮或明确说明下载方式。
- 用户可直接在浏览器中点击该下载按钮，将 Excel 文件保存到本地。

#### 7.2 数据库存储与本地文件

- **数据库存储（推荐与默认形态）**

  - 部署时配置 `DATABASE_URL` 后，系统在数据库中创建 `generated_reports` 等表；
  - 每次生成报表时，会将报表内容以二进制形式写入数据库，对外通过报表 ID 提供下载；
  - 业务系统可基于报表 ID 实现统一管理与审计。

---

### 8. 普通对话模式使用说明

在未进入报表配置模式，或在取消配置后，系统可作为通用的“专业知识问答助手”使用。

> **重要限制：普通对话模式不会主动读取或分析已上传的具体数据文件内容。**
> 它只基于内置的规则、文档与专业领域知识进行问答，不回答“某一上传文件中的具体数值/通道数据”等问题。

典型适用场景包括（仅做测试/测量领域的一般性专业知识问答，不涉及具体上传文件的数据分析）：

- 咨询测试与测量方面的专业知识，例如：

  - “发动机启动试验通常会关注哪些关键参数？”
  - “转速、压力、温度等通道在试验分析中的典型应用是什么？”
  - “如何从时间序列数据中识别出一次完整的升速-降速过程？”

在此模式下的对话不会修改现有报表配置，也不会访问、解析或引用某次上传的具体数据内容，仅用于提供解释和专业知识问答。

---

### 9. 常见问题与排查建议

#### 9.1 无法访问前端页面

- 现象：浏览器访问 `http://localhost:5173` 无响应或报错。
- 处理建议：
  - 确认前端服务已启动（执行 `npm run dev`）。
  - 使用 `netstat -ano | findstr ":5173"` 检查端口占用情况。
  - 如被其他程序占用，可结束相关进程或调整前端启动端口。

#### 9.2 无法访问后端接口 / AI 无响应

- 现象：前端提示无法连接接口或 AI 长时间无回复。
- 处理建议：
  - 确认后端服务已正常运行（`python main.py` 或 `start.bat`）。
  - 通过浏览器访问 `http://127.0.0.1:8000/api/health` 检查健康状态。
  - 检查 `.env` 中的 LLM API 密钥是否有效、是否存在网络访问限制。
  - 如仍无法解决，可查看后端日志信息并联系技术人员排查。

#### 9.3 文件上传失败

- 现象：上传时界面提示“文件上传失败”或“不支持的文件格式”。
- 处理建议：
  - 确认文件扩展名为 `.csv`、`.xlsx` 或 `.xls`。
  - 确认文件大小未超过系统配置的上限（默认 100MB，可在 `.env` 中通过 `MAX_FILE_SIZE` 调整）。
  - 如为网络盘或权限受限目录，请先复制到本地可读写目录后再上传。

#### 9.4 配置过程中需要中止或重来

- 处理建议：
  - 随时可点击顶部配置状态栏右侧的 **“取消配置”** 按钮，中止当前配置流程。
  - 如需重新配置报表，可在上传新文件或继续使用当前文件的基础上，再次选择报表类型并进行新的配置流程。

---

### 10. 注意事项

- **数据安全**：

  - 上传的试验数据文件及生成的报表文件应按单位数据安全规范进行管理和保管。
  - 建议定期清理服务器上的临时文件及历史报表，避免无节制占用磁盘空间。

- **密钥与配置安全**：

  - `.env` 文件中包含 LLM API 密钥及数据库连接信息，应妥善保管，禁止提交至版本控制系统或对外泄露。
  - 如怀疑密钥泄漏，应立即在对应平台重置密钥，并同步更新 `.env` 配置。

- **版本兼容性**：

  - 如前后端版本不一致（例如仅更新了后端），可能导致界面与接口定义不匹配。建议升级时保持前后端版本同步。

---

如需进一步了解系统内部实现细节、接口规范或算法逻辑，请参考：

- `README.md`（项目说明）
- `docs/开发文档.md`（整体技术说明）
- `docs/功能计算汇总表.md`（功能计算规则）
- 及其他随附的设计文档与方案文档。
