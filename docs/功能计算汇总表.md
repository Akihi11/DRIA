### **功能计算汇总表：开发规范文档**

#### 1. 概述

本模块的核心任务是分析完整的试验数据流，识别出一个或多个“升速-降速”循环，并计算每个循环中的关键性能指标。

- **输入**：一个 JSON 配置文件。计算模块将严格按照此 JSON 中定义的通道、阈值和算法来执行。
- **处理**：计算模块将实现一个**状态机 (State Machine)**，用于跟踪试验过程中的“升速” (RAMPING_UP) 和“降速” (RAMPING_DOWN) 阶段。它会捕获在每个阶段中**第一次**满足条件的事件时间点 。
- **输出**：一个 Excel 文件。全部计算完成后写入excel表中。



#### 2. JSON 配置文件结构

计算模块必须严格按照以下 JSON 结构读取配置。

```json
{
  "functionalCalc": {
    "time_base": {
      "channel": "Ng",
      "statistic": "平均值",
      "duration": 1,
      "logic": ">",
      "threshold": 500
    },
    "startup_time": {
      "channel": "Ng",
      "statistic": "平均值",
      "duration": 1,
      "logic": ">",
      "threshold": 100
    },
    "ignition_time": {
      "channel": "滑油压力",
      "type": "difference",
      "duration": 10,
      "logic": ">",
      "threshold": 500
    },
    "rundown_ng": {
      "channel": "Ng",
      "statistic": "平均值",
      "duration": 1,
      "threshold1": 2000,
      "threshold2": 200
    },
    "rundown_np": {
      "channel": "Np",
      "statistic": "平均值",
      "duration": 1,
      "threshold1": 6000,
      "threshold2": 500
    }
  }
}
```



##### 字段定义与计算逻辑

- **`functionalCalc.time_base` (“时间” - 基准时刻)**

    - **用途**：定义一个“基准时刻点” (T_Baseline)。这是升速阶段的一个关键绝对时间点 。
    - **算法**：在 `duration` 秒内的 `statistic` (平均值/最大值等) `logic` (>) `threshold` (500) 。
    - **捕获**：在“升速”阶段**第一次**满足此条件的绝对时间。

- **`functionalCalc.startup_time` (“启动时间”)**

    - **用途**：定义一个“启动时刻点” (T_Start)。
    - **算法**：在 `duration` 秒内的 `statistic` (平均值/最大值等) `logic` (>) `threshold` (100) 。
    - **捕获**：在“升速”阶段**第一次**满足此条件的绝对时间。
    - **最终计算**：`T_Baseline - T_Start`。这是一个**相对时长**。

- **`functionalCalc.ignition_time` (“点火时间”)**

    - **用途**：定义一个“点火时刻点” (T_Ignition)。
    - **算法**：`type` 为 `"difference"` 表示一个特殊算法：`(T_now_value - T_minus_duration_value)` 。当这个差值 `logic` (>) `threshold` (500) 时触发。
    - **捕获**：在“升速”阶段**第一次**满足此条件的绝对时间。
    - **最终计算**：`T_Ignition - T_Baseline`。这是一个**相对时长** 。

- **`functionalCalc.rundown_ng` / `rundown_np` (“Ng/Np余转时间”)**

    - **用途**：定义一个**相对时长**，用于衡量降速过程 。

    - **算法**：

        1. **T1**：在“降速”阶段，**第一次**捕获到 `statistic` 值 `logic` (<) `threshold1` 的绝对时间 。
        2. **T2**：在“降速”阶段，**第一次**捕获到 `statistic` 值 `logic` (<) `threshold2` 的绝对时间 。

    - **捕获**：`threshold1` 必须大于 `threshold2` 。

    - **最终计算**：`T2 - T1`。这是一个**相对时长** 。

        

------



#### 3. 计算模块实现逻辑 (状态机)

为确保“第一次”捕获规则得以执行 ，计算模块必须实现一个状态机。

##### 3.1. 初始化

1. **读取配置**：解析 `functionalCalc` JSON 对象。

2. **准备输出**：创建 Excel 工作簿和工作表。

3. **写入表头**：在工作表的第一行写入：`["启动次数", "时间", "启动时间", "点火时间", "Ng余转时间", "Np余转时间"]`。

4. **初始化全局变量**：

    ```
    State = "IDLE" // 当前状态
    Startup_Count = 0 // 启动次数
    Excel_Row_Index = 2 // Excel 写入行
    Current_Cycle_Data = {} // 存储当前循环捕获的所有时间点
    ```

5. **准备滑动窗口**：为 JSON 中配置的每个 `statistic` 和 `duration` 初始化所需的滑动窗口计算器。



##### 3.2. 数据处理循环 (核心状态机逻辑)



模块将逐个数据点 `(T_now, data_point)` 进行处理：

```python
while (data_point = get_next_data_point()):
    
    T_now = data_point.timestamp
    
    // --- 1. 实时计算所有需要的统计值 ---
    // (根据 JSON 配置，计算 Ng_Avg, Np_Avg, OilPressure_Diff 等)
    
    
    // --- 2. 状态机逻辑 ---
    switch (State):
        
        // --- 状态A: 空闲 (等待循环开始) ---
        case "IDLE":
            // 循环的开始以 "startup_time" (例如 Ng > 100) 为标志
            if (is_startup_time_met(data_point) AND Current_Cycle_Data.T_Start == NULL):
                Current_Cycle_Data.T_Start = T_now
                State = "RAMPING_UP" // 切换到升速状态
                
        // --- 状态B: 升速中 (RAMPING_UP) ---
        case "RAMPING_UP":
            // 捕获“启动时间”事件 (防止 IDLE 状态时未捕获到)
            if (is_startup_time_met(data_point) AND Current_Cycle_Data.T_Start == NULL):
                Current_Cycle_Data.T_Start = T_now
            
            // 捕获“时间”（基准）事件
            if (is_time_base_met(data_point) AND Current_Cycle_Data.T_Baseline == NULL):
                Current_Cycle_Data.T_Baseline = T_now
            
            // 捕获“点火时间”事件
            if (is_ignition_time_met(data_point) AND Current_Cycle_Data.T_Ignition == NULL):
                Current_Cycle_Data.T_Ignition = T_now
            
            // **状态切换：**
            // 当我们捕获到第一个 "降速" 事件 (T1) 时，认为升速阶段已结束
            // (假设 Ng T1 是主要判断依据)
            if (is_ng_rundown_T1_met(data_point) AND Current_Cycle_Data.T_Ng_T1 == NULL):
                Current_Cycle_Data.T_Ng_T1 = T_now
                State = "RAMPING_DOWN" // 切换到降速状态
                
        // --- 状态C: 降速中 (RAMPING_DOWN) ---
        case "RAMPING_DOWN":
            // 捕获 Ng T1 (如果升速阶段没捕获到)
            if (is_ng_rundown_T1_met(data_point) AND Current_Cycle_Data.T_Ng_T1 == NULL):
                Current_Cycle_Data.T_Ng_T1 = T_now
            
            // 捕获 Ng T2
            if (is_ng_rundown_T2_met(data_point) AND Current_Cycle_Data.T_Ng_T2 == NULL):
                Current_Cycle_Data.T_Ng_T2 = T_now
            
            // 捕获 Np T1
            if (is_np_rundown_T1_met(data_point) AND Current_Cycle_Data.T_Np_T1 == NULL):
                Current_Cycle_Data.T_Np_T1 = T_now
            
            // 捕获 Np T2
            if (is_np_rundown_T2_met(data_point) AND Current_Cycle_Data.T_Np_T2 == NULL):
                Current_Cycle_Data.T_Np_T2 = T_now
            
            // (允许在降速阶段补齐升速阶段未捕获的事件)
            if (is_time_base_met(data_point) AND Current_Cycle_Data.T_Baseline == NULL):
                Current_Cycle_Data.T_Baseline = T_now
            if (is_ignition_time_met(data_point) AND Current_Cycle_Data.T_Ignition == NULL):
                Current_Cycle_Data.T_Ignition = T_now

            // **状态切换 (循环结束)：**
            // 当所有 *启用* 的 T2 事件都已捕获时，认为循环结束
            if (All_Enabled_T2_Events_Found(Current_Cycle_Data, config)):
                State = "CALCULATE_ROW"
        
        // --- 状态D: 计算并写入行 ---
        case "CALCULATE_ROW":
            Startup_Count++
            
            // --- 执行最终计算 ---
            Calc_Time_Base = Current_Cycle_Data.T_Baseline // 基准绝对时刻
            Calc_Start_Time = (Current_Cycle_Data.T_Baseline - Current_Cycle_Data.T_Start)
            Calc_Ignition_Time = (Current_Cycle_Data.T_Ignition - Current_Cycle_Data.T_Baseline)
            Calc_Ng_Rundown = (Current_Cycle_Data.T_Ng_T2 - Current_Cycle_Data.T_Ng_T1)
            Calc_Np_Rundown = (Current_Cycle_Data.T_Np_T2 - Current_Cycle_Data.T_Np_T1)

            // --- 准备写入行 ---
            new_row = [
                Startup_Count,
                Calc_Time_Base,       // “时间” (绝对时刻)
                Calc_Start_Time,      // “启动时间” (相对秒)
                Calc_Ignition_Time,   // “点火时间” (相对秒)
                Calc_Ng_Rundown,      // “Ng余转时间” (相对秒)
                Calc_Np_Rundown       // “Np余转时间” (相对秒)
            ]
            
            // 写入 Excel (行号: Excel_Row_Index)
            
            // --- 重置 ---
            Excel_Row_Index++
            Current_Cycle_Data = {} // 清空当前循环数据
            State = "IDLE" // 返回空闲状态，等待下一个循环
            
// --- 循环结束 ---
// 保存 Excel 文件
```







### 计算规则逻辑

#### 1. 启动次数

- **计算方法**：软件在您的数据中寻找“升速-降速”的完整循环。每找到一个完整的循环，**“启动次数”就加1**。
- **简单理解**：就是数一数发动机总共启动了几次。



#### 2. 启动时间 

- **计算方法**：这个稍微复杂，需要两步：
    1. **找到基准点 (时间)**：软件首先会寻找一个“基准时刻点”，这个点是您设定的某个通道（比如Ng转速）的在固定统计时长内（比如1s）的平均值第一次超过一个较高阈值（比如500 RPM）的瞬间。
    2. **找到启动点**：然后，软件会寻找另一个“启动时刻点”，这个点是您设定的某个通道（比如Ng转速）的在固定统计时长内（比如1s）的平均值第一次超过一个较低阈值（比如100 RPM）的瞬间。
    3. **做减法**：“启动时间” = “基准时刻点” - “启动时刻点”。
- **简单理解**：它计算的是发动机从“刚刚开始转动”（超过100 RPM）到“真正有效运转”（超过500 RPM）**花了多长时间**。



#### 3. 点火时间

- **计算方法**：
    1. 软件会持续监测您为“点火”指定的通道（通常是压力或温度通道）。
    2. 它会不断地用当前时刻的信号值去减去10秒前的信号值，得到一个“差值”。
    3. 当这个“差值”**第一次**超过您设定的阈值时，软件就认为“点火”发生了，并记录下这一瞬间。
    4. 最终报表里的“点火时间”是这个瞬间相对于整个启动过程的相对时间。
- **简单理解**：通过寻找某个信号的**突然剧烈拉升**来自动捕捉“点火”这个动作发生的瞬间。



#### 4. Ng/Np余转时间

- **计算方法**：这个是在发动机**降速**过程中计算的。
    1. **找到高转速点 (T1)**：软件首先监测`Ng`或`Np`通道，找到转速**第一次**从高处下降到低于一个较高阈值（比如1000 RPM）的瞬间，记为T1。
    2. **找到低转速点 (T2)**：然后，软件继续监测，找到转速**第一次**下降到低于一个更低阈值（比如100 RPM）的瞬间，记为T2。
    3. **做减法**：“余转时间” = T2 - T1。
- **简单理解**：它计算的是发动机从“较高转速”滑行至“较低转速”**所花费的时间**，用来衡量其转动惯性。



#### 计算逻辑说明

此表格的生成条件是，在数据中识别出一次或多次完整的“启动-停机”循环。脚本在每个循环的“升速”和“降速”阶段，寻找**第一次**满足条件的时间点来计算各项指标，具体如下：

- **时间**：`Ng`在1秒内的平均值首次 > 500 RPM的时刻。
- **启动时间**：`Ng`在1秒内的平均值首次 > 100 RPM的时刻，与上述“时间”的差值。
- **点火时间**：`滑油压力`的瞬时值与10秒前的差值首次 > 500 的时刻，与上述“时间”的差值。
- **Ng/Np余转时间**：在降速过程中，`Ng`/`Np`在1秒内的平均值从首次 < 2000 RPM到首次 < 200 RPM所用的时长。
- **启动次数**：计算出的完整循环次数。

**【生成结果示例】计算汇总表** 

| 启动次数 | 时间   | 启动时间 | 点火时间 | Ng余转时间 | Np余转时间 |
| -------- | ------ | -------- | -------- | ---------- | ---------- |
| 1        | 3.25s  | 2.40s    | 4.15s    | 10.79s     | 10.79s     |
| 2        | 62.93s | 2.14s    | 4.21s    | 9.64s      | 9.64s      |

